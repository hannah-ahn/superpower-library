<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
  </style>
</head>
<body>
  <script>
    const APP_URL = 'https://superpower-library.vercel.app';

    window.onmessage = async (event) => {
      const msg = event.data.pluginMessage;

      if (msg.type === 'upload') {
        try {
          const blob = new Blob([new Uint8Array(msg.bytes)], { type: 'image/png' });
          const formData = new FormData();
          formData.append('file', blob, msg.filename);

          const response = await fetch(APP_URL + '/api/assets', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + msg.token
            },
            body: formData
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Upload failed');
          }

          parent.postMessage({ pluginMessage: { type: 'upload-complete' } }, '*');
        } catch (error) {
          parent.postMessage({
            pluginMessage: {
              type: 'upload-error',
              error: error.message
            }
          }, '*');
        }
      }

      if (msg.type === 'open-url') {
        window.open(msg.url, '_blank');
      }
    };

    // Listen for auth callback (if opened in plugin UI)
    if (window.location.hash.includes('token=')) {
      const params = new URLSearchParams(window.location.hash.substring(1));
      const tokenData = params.get('token');
      const state = params.get('state');

      if (tokenData && state) {
        try {
          const token = JSON.parse(atob(tokenData));
          parent.postMessage({
            pluginMessage: {
              type: 'auth-callback',
              token: token,
              state: state
            }
          }, '*');
        } catch (e) {
          console.error('Failed to parse token:', e);
        }
      }
    }
  </script>
</body>
</html>
